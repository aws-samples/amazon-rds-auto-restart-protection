{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "SnsTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "Subscription": [{
          "Endpoint": {
            "Fn::GetAtt": ["LambdaStartExecution", "Arn"]
          },
          "Protocol": "lambda"
        }],
        "Tags": [{
          "Key": "Project",
          "Value": "RdsAutoStartProtection"
        }]
      },
      "DependsOn": ["LambdaStartExecution"]

    },
    "LambdaStartExecution": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Ref" : "s3Bucket" },
          "S3Key": "Lambda_RdsAutoRestart_startWorkFlow.zip"
        },
        "Description": "Lambda function to start the Step Functions state machine execution",
        "Handler": "lambda_function.lambda_handler",
        "Environment": {
          "Variables": {
            "STEPFUNCTION_ARN": {
              "Ref": "StepFunction"
            }
          }
        },
        "Role": {
          "Fn::ImportValue": "first-RoleLambda01"
        },
        "Runtime": "python3.7",
        "Tags": [{
          "Key": "Project",
          "Value": "RdsAutoStartProtection"
        }]
      }
    },
    "LambdaRetrieveInstanceStatus": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Ref" : "s3Bucket" },
          "S3Key": "Lambda_RdsAutoRestart_retrieveRdsInstanceState.zip"
        },
        "Description": "Lambda function to retrieve the state of an RDS instance",
        "Handler": "lambda_function.lambda_handler",
        "Role": {
          "Fn::ImportValue": "first-RoleLambda03"
        },
        "Runtime": "python3.7",
        "Tags": [{
          "Key": "Project",
          "Value": "RdsAutoStartProtection"
        }]
      }
    },
    "LambdaStopRdsInstance": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Ref" : "s3Bucket" },
          "S3Key": "Lambda_RdsAutoRestart_stopRdsInstance.zip"
        },
        "Description": "Lambda function to stop an RDS instance",
        "Handler": "lambda_function.lambda_handler",
        "Role": {
          "Fn::ImportValue": "first-RoleLambda02"
        },
        "Runtime": "python3.7",
        "Tags": [{
          "Key": "Project",
          "Value": "RdsAutoStartProtection"
        }]
      }
    },
    "LambdaInvokePermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "Principal": "sns.amazonaws.com",
        "SourceArn": {
          "Ref": "SnsTopic"
        },
        "FunctionName": {
          "Fn::GetAtt": ["LambdaStartExecution", "Arn"]
        }
      }
    },
    "StepFunction": {
      "Type": "AWS::StepFunctions::StateMachine",
      "Properties": {
        "DefinitionS3Location": {
          "Bucket": { "Ref" : "s3Bucket" },
          "Key": "StepFunctions.json"

        },
        "DefinitionSubstitutions": {

          "LambdaRetrieveInstanceStatus": {
            "Fn::GetAtt": ["LambdaRetrieveInstanceStatus", "Arn"]
          },
          "LambdaStopRdsInstance": {
            "Fn::GetAtt": ["LambdaStopRdsInstance", "Arn"]
          }
        },
        "RoleArn": {
          "Fn::ImportValue": "first-RoleStepFunctions01"
        },
        "StateMachineType": "STANDARD",
        "Tags": [{
          "Key": "Project",
          "Value": "RdsAutoStartProtection"
        }]
      }
    }
  },
  "Parameters" : {
  "s3Bucket" : {
    "Type" : "String",
    "Description" : "S3 Bucket where your Lambda and Step Functions are stored."
  }
}
}
